---
import Layout from '../../layouts/Layout.astro';
import Menu from '../../components/Menu.astro';
---
<Layout>
  <Menu active="/diasentrega" />
  <main class="container py-4">
    <h1 class="display-6 fw-bold mb-4 text-center text-primary">Días de Entrega</h1>
    <div id="dias-list"></div>
    <form id="form-dias" class="card p-4 shadow-sm mb-4">
      <div class="mb-3">
        <input name="dia" placeholder="Día" class="form-control" required />
      </div>
      <input type="hidden" name="id" />
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'><path d='M8 1a.5.5 0 0 1 .5.5V7.5H14.5a.5.5 0 0 1 0 1H8.5V14.5a.5.5 0 0 1-1 0V8.5H1.5a.5.5 0 0 1 0-1H7.5V1.5A.5.5 0 0 1 8 1z'/></svg>
          Guardar
        </button>
        <button type="button" id="cancel-edit" class="btn btn-secondary d-none">Cancelar</button>
      </div>
    </form>
    <script type="module">
      let editingId = null;
      async function fetchDias() {
        const res = await fetch('/api/diasEntrega');
        const data = await res.json();
        const list = document.getElementById('dias-list');
        list.innerHTML = data.map(d => `
          <div class='card mb-2 shadow-sm'>
            <div class='card-body d-flex flex-column flex-md-row justify-content-between align-items-center'>
              <div class='fw-semibold text-primary'>${d.dia}</div>
              <div class='d-flex gap-2 mt-2 mt-md-0'>
                <button data-id='${d.id}' class='edit-btn btn btn-outline-primary btn-sm'>
                  <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='#0d6efd' viewBox='0 0 16 16'><path d='M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 3 10.707V13h2.293l7.5-7.5z'/></svg>
                  Editar
                </button>
                <button data-id='${d.id}' class='delete-btn btn btn-outline-danger btn-sm'>
                  <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='#dc3545' viewBox='0 0 16 16'><path d='M5.5 5.5A.5.5 0 0 1 6 5h4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5H6a.5.5 0 0 1-.5-.5v-7zM4.118 4 4 4.059V13.5A1.5 1.5 0 0 0 5.5 15h5A1.5 1.5 0 0 0 12 13.5V4.059L11.882 4H4.118zM2.5 3a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1H15a.5.5 0 0 1 0 1h-1v10.5A2.5 2.5 0 0 1 11.5 17h-7A2.5 2.5 0 0 1 2 14.5V4H1a.5.5 0 0 1 0-1h1.5z'/></svg>
                  Eliminar
                </button>
              </div>
            </div>
          </div>
        `).join('');
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.onclick = async () => {
            await fetch('/api/diasEntrega', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: btn.dataset.id })
            });
            fetchDias();
          };
        });
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.onclick = () => {
            const dia = data.find(d => d.id == btn.dataset.id);
            const form = document.getElementById('form-dias');
            form.dia.value = dia.dia;
            form.id.value = dia.id;
            editingId = dia.id;
            form.querySelector('#cancel-edit').classList.remove('d-none');
          };
        });
      }
      fetchDias();
      document.getElementById('form-dias').onsubmit = async e => {
        e.preventDefault();
        const form = e.target;
        const body = {
          dia: form.dia.value,
          id: form.id.value || undefined
        };
        await fetch('/api/diasEntrega', {
          method: body.id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        form.reset();
        editingId = null;
        form.querySelector('#cancel-edit').classList.add('d-none');
        fetchDias();
      };
      document.getElementById('cancel-edit').onclick = () => {
        const form = document.getElementById('form-dias');
        form.reset();
        editingId = null;
        form.querySelector('#cancel-edit').classList.add('d-none');
      };
    </script>
  </main>
</Layout>
