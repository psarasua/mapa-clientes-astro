---
import Layout from '../layouts/Layout.astro';
import MapaClientes from '../components/MapaClientes.astro';
---

<Layout title="Mapa de Clientes">
	<main>
		<div class="container">
			<header class="header">
				<h1>üó∫Ô∏è Mapa de Clientes</h1>
				<div class="acciones-header">
					<a href="/clientes/nuevo" class="btn-nuevo">
						‚ûï Nuevo Cliente
					</a>
					<button onclick="agregarClienteEnMapa()" class="btn-mapa">
						üìç Agregar en Mapa
					</button>
				</div>
			</header>

			<div class="contenido">
				<section class="seccion-mapa">
					<h2>Ubicaciones de Clientes</h2>
					<MapaClientes />
				</section>

				<section class="seccion-lista">
					<h2>Lista de Clientes</h2>
					<div id="listaClientes" class="lista-clientes">
						<div class="cargando">Cargando clientes...</div>
					</div>
				</section>
			</div>
		</div>
	</main>
</Layout>

<style>
	.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 20px;
	}

	.header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 30px;
		padding-bottom: 20px;
		border-bottom: 2px solid #e9ecef;
	}

	.header h1 {
		color: #333;
		margin: 0;
		font-size: 2.5rem;
	}

	.acciones-header {
		display: flex;
		gap: 10px;
	}

	.btn-nuevo,
	.btn-mapa {
		background-color: #007bff;
		color: white;
		text-decoration: none;
		padding: 12px 20px;
		border-radius: 6px;
		font-weight: bold;
		transition: background-color 0.3s;
		border: none;
		cursor: pointer;
		font-size: 14px;
	}

	.btn-nuevo:hover,
	.btn-mapa:hover {
		background-color: #0056b3;
	}

	.btn-mapa {
		background-color: #28a745;
	}

	.btn-mapa:hover {
		background-color: #218838;
	}

	.contenido {
		display: grid;
		grid-template-columns: 2fr 1fr;
		gap: 30px;
	}

	.seccion-mapa,
	.seccion-lista {
		background: white;
		padding: 20px;
		border-radius: 8px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	}

	.seccion-mapa h2,
	.seccion-lista h2 {
		margin-top: 0;
		color: #333;
		border-bottom: 2px solid #f8f9fa;
		padding-bottom: 10px;
	}

	.lista-clientes {
		max-height: 500px;
		overflow-y: auto;
	}

	.cliente-item {
		border: 1px solid #e9ecef;
		border-radius: 6px;
		padding: 15px;
		margin-bottom: 10px;
		transition: box-shadow 0.3s;
	}

	.cliente-item:hover {
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
	}

	.cliente-nombre {
		font-weight: bold;
		color: #007bff;
		margin-bottom: 5px;
		font-size: 1.1rem;
	}

	.cliente-info {
		color: #666;
		font-size: 0.9rem;
		margin-bottom: 3px;
	}

	.cliente-acciones {
		margin-top: 10px;
		display: flex;
		gap: 5px;
	}

	.btn-editar,
	.btn-eliminar {
		padding: 5px 10px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-size: 12px;
		text-decoration: none;
		display: inline-block;
	}

	.btn-editar {
		background-color: #ffc107;
		color: #212529;
	}

	.btn-eliminar {
		background-color: #dc3545;
		color: white;
	}

	.btn-editar:hover {
		background-color: #e0a800;
	}

	.btn-eliminar:hover {
		background-color: #c82333;
	}

	.cargando {
		text-align: center;
		padding: 20px;
		color: #666;
		font-style: italic;
	}

	.sin-clientes {
		text-align: center;
		padding: 40px;
		color: #666;
	}

	@media (max-width: 768px) {
		.header {
			flex-direction: column;
			gap: 15px;
			text-align: center;
		}

		.header h1 {
			font-size: 2rem;
		}

		.contenido {
			grid-template-columns: 1fr;
		}

		.acciones-header {
			justify-content: center;
		}
	}
</style>

<script>
	async function cargarListaClientes() {
		try {
			const response = await fetch('/api/clientes');
			const result = await response.json();

			const container = document.getElementById('listaClientes');

			if (result.success && result.data.length > 0) {
				container.innerHTML = result.data.map(cliente => `
					<div class="cliente-item">
						<div class="cliente-nombre">${cliente.nombre}</div>
						<div class="cliente-info">üìß ${cliente.email || 'No especificado'}</div>
						<div class="cliente-info">üìû ${cliente.telefono || 'No especificado'}</div>
						<div class="cliente-info">üìç ${cliente.direccion || 'No especificada'}</div>
						${cliente.latitud && cliente.longitud ? 
							`<div class="cliente-info">üåç ${cliente.latitud.toFixed(4)}, ${cliente.longitud.toFixed(4)}</div>` : 
							'<div class="cliente-info">üåç Ubicaci√≥n no especificada</div>'
						}
						<div class="cliente-acciones">
							<a href="/clientes/editar/${cliente.id}" class="btn-editar">‚úèÔ∏è Editar</a>
							<button onclick="eliminarClienteLista(${cliente.id})" class="btn-eliminar">üóëÔ∏è Eliminar</button>
						</div>
					</div>
				`).join('');
			} else {
				container.innerHTML = '<div class="sin-clientes">No hay clientes registrados. ¬°Agrega el primero!</div>';
			}
		} catch (error) {
			console.error('Error cargando clientes:', error);
			document.getElementById('listaClientes').innerHTML = 
				'<div class="sin-clientes">Error cargando clientes. Intenta recargar la p√°gina.</div>';
		}
	}

	window.eliminarClienteLista = async function(id) {
		if (confirm('¬øEst√°s seguro de que quieres eliminar este cliente?')) {
			try {
				const response = await fetch(`/api/clientes/${id}`, {
					method: 'DELETE'
				});
				const result = await response.json();

				if (result.success) {
					alert('Cliente eliminado exitosamente');
					await cargarListaClientes();
					// Recargar el mapa tambi√©n
					if (window.cargarClientes) {
						await window.cargarClientes();
					}
				} else {
					alert('Error al eliminar cliente: ' + result.error);
				}
			} catch (error) {
				alert('Error: ' + error.message);
			}
		}
	};

	// Cargar lista cuando se carga la p√°gina
	document.addEventListener('DOMContentLoaded', cargarListaClientes);
</script>
