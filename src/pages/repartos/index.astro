---
import Layout from '../../layouts/Layout.astro';
import Menu from '../../components/Menu.astro';
---
<Layout>
  <Menu active="/repartos" />
  <main class="container py-4">
    <h1 class="display-6 fw-bold mb-4 text-center text-primary">Repartos</h1>
    <div id="repartos-list"></div>
    <form id="form-repartos" class="card p-4 shadow-sm mb-4">
      <div class="mb-3">
        <input name="camion_id" placeholder="ID Camión" type="number" class="form-control" required />
      </div>
      <div class="mb-3">
        <input name="dia_id" placeholder="ID Día" type="number" class="form-control" required />
      </div>
      <input type="hidden" name="id" />
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'><path d='M8 1a.5.5 0 0 1 .5.5V7.5H14.5a.5.5 0 0 1 0 1H8.5V14.5a.5.5 0 0 1-1 0V8.5H1.5a.5.5 0 0 1 0-1H7.5V1.5A.5.5 0 0 1 8 1z'/></svg>
          Guardar
        </button>
        <button type="button" id="cancel-edit" class="btn btn-secondary d-none">Cancelar</button>
      </div>
    </form>
    <script type="module">
      let editingId = null;
      async function fetchRepartos() {
        const res = await fetch('/api/repartos');
        const data = await res.json();
        const list = document.getElementById('repartos-list');
        if (data.length === 0) {
          list.innerHTML = `<div class='alert alert-info text-center'>No hay repartos registrados.</div>`;
          return;
        }
        list.innerHTML = `
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-primary">
                <tr>
                  <th>Camión ID</th>
                  <th>Día ID</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(r => `
                  <tr>
                    <td class="fw-semibold text-primary">${r.camion_id}</td>
                    <td>${r.dia_id}</td>
                    <td class="text-center">
                      <div class="d-flex gap-2 justify-content-center">
                        <button data-id='${r.id}' class='edit-btn btn btn-outline-warning btn-sm' title="Editar">
                          <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='#ffc107' viewBox='0 0 16 16'><path d='M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 3 10.707V13h2.293l7.5-7.5z'/></svg>
                        </button>
                        <button data-id='${r.id}' class='delete-btn btn btn-outline-danger btn-sm' title="Eliminar">
                          <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='#dc3545' viewBox='0 0 16 16'><path d='M5.5 5.5A.5.5 0 0 1 6 5h4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5H6a.5.5 0 0 1-.5-.5v-7zM4.118 4 4 4.059V13.5A1.5 1.5 0 0 0 5.5 15h5A1.5 1.5 0 0 0 12 13.5V4.059L11.882 4H4.118zM2.5 3a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1H15a.5.5 0 0 1 0 1h-1v10.5A2.5 2.5 0 0 1 11.5 17h-7A2.5 2.5 0 0 1 2 14.5V4H1a.5.5 0 0 1 0-1h1.5z'/></svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.onclick = async () => {
            await fetch('/api/repartos', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: btn.dataset.id })
            });
            fetchRepartos();
          };
        });
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.onclick = () => {
            const reparto = data.find(r => r.id == btn.dataset.id);
            const form = document.getElementById('form-repartos');
            form.camion_id.value = reparto.camion_id;
            form.dia_id.value = reparto.dia_id;
            form.id.value = reparto.id;
            editingId = reparto.id;
            form.querySelector('#cancel-edit').classList.remove('d-none');
          };
        });
      }
      fetchRepartos();
      document.getElementById('form-repartos').onsubmit = async e => {
        e.preventDefault();
        const form = e.target;
        const body = {
          camion_id: form.camion_id.value,
          dia_id: form.dia_id.value,
          id: form.id.value || undefined
        };
        await fetch('/api/repartos', {
          method: body.id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        form.reset();
        editingId = null;
        form.querySelector('#cancel-edit').classList.add('d-none');
        fetchRepartos();
      };
      document.getElementById('cancel-edit').onclick = () => {
        const form = document.getElementById('form-repartos');
        form.reset();
        editingId = null;
        form.querySelector('#cancel-edit').classList.add('d-none');
      };
    </script>
  </main>
</Layout>
